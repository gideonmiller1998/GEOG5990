# -*- coding: utf-8 -*-
"""
Created on Fri Mar 18 15:07:42 2022

@author: gideo
"""

import csv
import matplotlib
import matplotlib.animation
from copy import deepcopy
import drunkframework
import tkinter
import random


def load_town(file):
    drunk_town = []
    f = open(file, newline='')
    reader = csv.reader(f, quoting=csv.QUOTE_NONNUMERIC)
    for row in reader:
        rowlist = []
        for value in row:
            rowlist.append(value)
        drunk_town.append(rowlist)
    f.close() 
    return drunk_town

def plot_town(town):
    town = deepcopy(town)
    # houses = list(range(10,260,10))
    # num2cidx = {"0":0, "1":1}
    # for house in houses:
    #     num2cidx[str(house)] = 2
    # for i in range(len(town)):
    #     for j in range(len(town[i])):
    #         town[i][j] = num2cidx[str(int(town[i][j]))]


    matplotlib.pyplot.ylim(0, len(town[0]))
    matplotlib.pyplot.xlim(0, len(town))
    matplotlib.pyplot.imshow(town)


    
def main():
    drunk_town = load_town("drunk.txt") 
    density_town = deepcopy(drunk_town)
    plot_town(drunk_town)
    fig = matplotlib.pyplot.figure(figsize=(7, 7))
    ax = fig.add_axes([0, 0, 1, 1])

    
    def update(framenumber):
        fig.clear()
        drunkman.move()
        drunkman.density()
        #print(drunkman)
        plot_town(drunk_town)
        drunkman.show()
        ax.scatter(random.randint(0,300),random.randint(0,300), color = "white")
        
    def gen_function():   
        a = 0
        while drunkman is None or drunk_town[drunkman.y][drunkman.x] != drunkman.housenumber:
            yield a
            a = a + 1
        
    def start():
        global drunkman
        for i in range(1):
            drunkman = drunkframework.person(150, 150, (i+1)*10, density_town)
            animation = matplotlib.animation.FuncAnimation(fig, update, frames=gen_function, repeat=False)
            canvas.draw() 
            matplotlib.pyplot.show()
        plot_town(density_town)
        drunkman.show()

        f2 = open('drunk_desnity.txt', 'w', newline='')
        writer = csv.writer(f2)
        for row in density_town: 
            writer.writerow(row)
        f2.close()
        
    root = tkinter.Tk()
    root.wm_title("Model")
    canvas = matplotlib.backends.backend_tkagg.FigureCanvasTkAgg(fig, master=root)
    canvas._tkcanvas.pack(side=tkinter.TOP, fill=tkinter.BOTH, expand=1)    
    run_button = tkinter.Button(root, text = "Run", command = start)
    run_button.pack()
    
    root.mainloop() 
           
    
        

if __name__ == "__main__":
    main()
    
